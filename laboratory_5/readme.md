# Лабораторная работа №5. Работа с базой данных

## Цель работы

Освоить архитектуру с единой точкой входа, подключение шаблонов для визуализации страниц, а также переход от хранения данных в файле к использованию базы данных (MySQL).

## Условия

Продолжите разработку проекта, начатого в предыдущей лабораторной работе, необходимо:

- Реализовать архитектуру с единой точкой входа (index.php), обрабатывающей все входящие HTTP-запросы.
- Настроить базовую систему шаблонов с использованием файла layout.php и отдельных представлений для разных страниц.
- Перенести логику работы с рецептами из файловой системы в базу данных (например, MySQL).

## Задание 1. Подготовка среды

Настраиваю базу данные при помощи `docker-compose.yml` где я поднимаю базу данных `MySQL`

При помощи `Phinx` создаю миграции для таблиц

`Categories`:

```php
<?php

declare(strict_types=1);

use Phinx\Migration\AbstractMigration;

final class CreateCategoriesTable extends AbstractMigration
{
    public function up(): void
    {
        $table = $this->table('categories');
        $table
            ->addColumn('name', 'string', ['limit' => 100])
            ->addColumn('created_at', 'timestamp', [
                'default' => 'CURRENT_TIMESTAMP'
            ])
            ->addIndex(['name'], ['unique' => true])
            ->create();
    }

    public function down(): void
    {
        $this->table('categories')->drop()->save();
    }
}
```

`Recipes`:

```php
<?php

declare(strict_types=1);

use Phinx\Migration\AbstractMigration;

final class CreateRecipesTable extends AbstractMigration
{
    public function up(): void
    {
        $table = $this->table('recipes');
        $table
            ->addColumn('title', 'string', ['limit' => 255])
            ->addColumn('category', 'integer', ['signed' => false])
            ->addColumn('ingredients', 'text', ['null' => true])
            ->addColumn('description', 'text', ['null' => true])
            ->addColumn('tags', 'text', ['null' => true])
            ->addColumn('steps', 'text', ['null' => true])
            ->addColumn('created_at', 'timestamp', [
                'default' => 'CURRENT_TIMESTAMP'
            ])
            ->addForeignKey('category', 'categories', 'id', [
                'delete' => 'CASCADE',
                'update' => 'NO_ACTION'
            ])
            ->create();
    }

    public function down(): void
    {
        $this->table('recipes')->drop()->save();
    }
}

```


## Задание 2. Архитектура и шаблонизация

В корневой папке `public/` создаю файл `index.php`, который будет служить основной точкой входа.

Настраваю простейшую маршрутизацию, которая будет обрабатывать запросы к различным страницам приложения при помощи `Router`

Создаю файл `templates/layouts/default.layout.php`, который будет базовым шаблоном для всех страниц

Создаю шаблоны для следующих страниц:
- `index` — отображение всех рецептов;
- `create` — форма добавления рецепта;
- `recipe` — страница с подробной информацией о рецепте.

## Задание 3. Подключение к базе данных

При помощи `.env` файла `config.php` файла и `PDODatabase` класса создаю подключение к базе данных и использую для `CRUD` операций

Пример `Create`

```php
$id = PDODatabase::Create('recipes', $data);
```

Также создаю `InputHandler` в котором методы `validate` и `filter` отвечают за валидацию и фильтрацию соответсвенно

## Задание 4. Защита от SQL-инъекций

При помощи подготовленных выражений избегаю возможность sql инъекции 

Типичная sql инъекция: `105 OR 1=1` которую я предотвратил при помощи подготовленных выражений

## Задание 5. Дополнительное задание. Пагинация

При помощи переменной `$page` и `$limit` определяю количество рецептов на странице после чего могу переключатся вычисляя `offset` таким образом `$page * $limit`

## Контрольные вопросы

> **Q:** Какие преимущества даёт использование единой точки входа в веб-приложении?  
> **A:** Единая точка входа упрощает управление запросами, позволяет централизованно настраивать авторизацию, безопасность и маршрутизацию. Это облегчает поддержку, масштабирование, логирование и повышает общую безопасность приложения.

---

> **Q:** Какие преимущества даёт использование шаблонов?
> **A:** Шаблоны упрощают разделение логики и представления, ускоряют разработку интерфейсов, повышают читаемость и переиспользуемость кода, а также позволяют легко поддерживать единый стиль оформления.

---

> **Q:** Какие преимущества даёт хранение данных в базе по сравнению с хранением в файлах?
> **A:** Хранение данных в базе обеспечивает быструю и надёжную выборку, защиту от потери при сбоях, поддержку одновременного доступа, удобный поиск и фильтрацию, а также масштабируемость при росте объёмов информации.

---

> **Q:** Что такое SQL-инъекция? Придумайте пример SQL-инъекции и объясните, как её предотвратить.
> **A:** SQL-инъекция — это уязвимость, при которой злоумышленник вставляет вредоносный SQL-код в запрос через вводимые данные, чтобы получить доступ к базе или изменить её содержимое.
>
> Пример:
> Пусть есть запрос:
>
>```sql
>   SELECT * FROM users WHERE username = '$username' AND password = '$password';
>```
>
> Если пользователь введёт username = 'admin' и password = ' OR '1'='1, итоговый запрос станет:
>
>```sql
>    SELECT * FROM users WHERE username = 'admin' AND password = '' OR '1'='1';
>```
> Чтобы предотвратить используют подготовленные выражения (prepared statements), экранирование данных и валидацию ввода.